# Rise.sk Server Block Configuration
# HTTP -> HTTPS redirect + main server

# Redirect HTTP to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name rise.sk www.rise.sk;

    # Let's Encrypt challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Redirect all other traffic to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# Main HTTPS server
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name rise.sk www.rise.sk;

    # SSL certificates (Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/rise.sk/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/rise.sk/privkey.pem;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;

    # HSTS (enable after testing)
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Rate limiting (only for dynamic requests, not static)
    # Static files are excluded from rate limiting below
    limit_conn addr 100;

    # Static files caching (Next.js _next/static) - NO rate limiting
    location /_next/static/ {
        proxy_pass http://nextjs;
        proxy_cache_valid 200 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # Next.js image optimization
    location /_next/image {
        proxy_pass http://nextjs;
        proxy_cache_valid 200 7d;
        add_header Cache-Control "public, max-age=604800";
    }

    # Public static assets
    location /optimized/ {
        proxy_pass http://nextjs;
        proxy_cache_valid 200 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    location /images/ {
        proxy_pass http://nextjs;
        proxy_cache_valid 200 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    location /rise/ {
        proxy_pass http://nextjs;
        proxy_cache_valid 200 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # Favicon and manifest
    location ~* \.(ico|webmanifest|xml)$ {
        proxy_pass http://nextjs;
        proxy_cache_valid 200 7d;
        add_header Cache-Control "public, max-age=604800";
    }

    # API routes - stricter rate limiting
    location /api/ {
        limit_req zone=api burst=10 nodelay;
        proxy_pass http://nextjs;
        proxy_read_timeout 30s;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }

    # Keystatic admin (if needed)
    location /keystatic/ {
        proxy_pass http://nextjs;
        proxy_read_timeout 60s;
        add_header Cache-Control "no-store";
    }

    # Health check endpoint
    location /api/health {
        proxy_pass http://nextjs;
        access_log off;
    }

    # Main application
    location / {
        limit_req zone=general burst=50 nodelay;
        proxy_pass http://nextjs;
        proxy_read_timeout 60s;
        
        # ISR/SSR caching
        proxy_cache_valid 200 1h;
        add_header X-Cache-Status $upstream_cache_status;
    }

    # Error pages
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
