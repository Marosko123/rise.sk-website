# Rise.sk Server Block Configuration
# HTTP -> HTTPS redirect + main server

# Redirect HTTP to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name rise.sk www.rise.sk;

    # Let's Encrypt challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Redirect all other traffic to HTTPS (forcing rise.sk)
    location / {
        return 301 https://rise.sk$request_uri;
    }
}

# Redirect www.rise.sk to rise.sk (HTTPS)
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name www.rise.sk;

    # SSL certificates (Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/rise.sk/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/rise.sk/privkey.pem;

    return 301 https://rise.sk$request_uri;
}

# Main HTTPS server (rise.sk)
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name rise.sk;

    # SSL certificates (Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/rise.sk/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/rise.sk/privkey.pem;

    # Security headers - DELEGATED TO NEXT.JS
    # Redundant headers in Nginx cause "Bad Request" (400) errors in some browsers/proxies
    # when the same header is sent twice. Next.js already handles CSP, HSTS, X-Frame-Options, etc.

    # Rate limiting (only for dynamic requests, not static)
    limit_conn addr 100;

    # Explicit Metadata Routes
    location = /robots.txt {
        proxy_pass http://nextjs/robots.txt;
        add_header Cache-Control "public, max-age=3600, must-revalidate";
    }

    location = /sitemap.xml {
        proxy_pass http://nextjs/sitemap.xml;
        add_header Cache-Control "public, max-age=3600, must-revalidate";
    }

    # Static files caching (Next.js _next/static) - NO rate limiting
    location /_next/static/ {
        proxy_pass http://nextjs;
        proxy_cache_valid 200 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # Next.js image optimization
    location /_next/image {
        proxy_pass http://nextjs;
        proxy_cache_valid 200 7d;
        add_header Cache-Control "public, max-age=604800";
    }

    # Public static assets
    location /optimized/ {
        proxy_pass http://nextjs;
        proxy_cache_valid 200 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    location /images/ {
        proxy_pass http://nextjs;
        proxy_cache_valid 200 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    location /rise/ {
        proxy_pass http://nextjs;
        proxy_cache_valid 200 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # Favicon and manifest
    location ~* \.(ico|webmanifest)$ {
        proxy_pass http://nextjs;
        proxy_cache_valid 200 7d;
        add_header Cache-Control "public, max-age=604800";
    }

    # API routes - stricter rate limiting
    location /api/ {
        limit_req zone=api burst=10 nodelay;
        proxy_pass http://nextjs;
        proxy_read_timeout 30s;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }

    # Keystatic admin
    location /keystatic/ {
        proxy_pass http://nextjs;
        proxy_read_timeout 60s;
        add_header Cache-Control "no-store";
    }

    # Health check endpoint
    location /api/health {
        proxy_pass http://nextjs;
        access_log off;
    }

    # Main application
    location / {
        limit_req zone=general burst=50 nodelay;
        proxy_pass http://nextjs;
        proxy_read_timeout 60s;

        # ISR/SSR caching
        proxy_cache_valid 200 1h;
        add_header X-Cache-Status $upstream_cache_status;
    }

    # Error pages
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
